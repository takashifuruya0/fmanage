{% extends "kakeibo/base.html" %}
{% load humanize %}
{% block title %}
    Dashboard
{% endblock %}
 
{% block body %}
  
<div class="container-fluid">
  <hr>
  <div class="row">
    <div class="col-md-6 col-sm-12 col-12">
      <h1>
        <i class="fas fa-chart-area"></i> {{today.year}}年{{today.month}}月の概要
      </h1>
    </div>
    <div class="col-md-2 col-sm-4 col-6">
      <button type="button" class="btn btn-outline-info btn-block" data-toggle="modal" data-target="#new_record">
        <i class="far fa-plus-square"></i> New record
      </button>
    </div>
    <div class="col-md-2 col-sm-4 col-6">
      <button type="button" class="btn btn-outline-secondary btn-block" data-toggle="modal" data-target="#read_csv">
        <i class="far fa-file-excel"></i> Credit CSV
      </button>
    </div>
  </div>
  <hr>

  <!--家計簿-->
  <div class="row" id="link-kakeibo">
    <div class="col-sm-6">
      <h2><i class="fas fa-user-circle"></i> 家計簿</h2>
    </div>
  </div>
  <div class="row">
    <div class="col-sm-6 col-md-3 col-lg-2">
      <button class="btn btn-block btn-lg btn-{{status.kakeibo}}">
        収支 <span class="badge badge-light">¥{{inout | intcomma}}</span>
      </button>
    </div>
    <div class="col-sm-6 col-md-3 col-lg-2">
      <button class="btn btn-block btn-lg btn-info">
        総資産 <span class="badge badge-light">¥{{total | intcomma}}</span>
      </button>
    </div>
    <div class="col-sm-12 col-md-6 col-lg-8">
      <div class="progress" style="height:25px">
        <div class="progress-bar bg-success progress-bar-striped" style="width:{{pb.kakeibo.in}}%; height:25px">
          収入 <span class="badge badge-light">¥{{income | intcomma}}</span>
        </div>
      </div>
      <div class="progress" style="height:25px">
        <div class="progress-bar bg-warning progress-bar-striped" style="width:{{pb.kakeibo.out}}%; height:25px">
          支出 <span class="badge badge-light">¥{{expense | intcomma}}</span>
        </div>
      </div>
    </div>
  </div>
  <hr>
  <div class="row">
    <div class="col-sm-12 col-md-6 col-lg-3">
      <div class="card">
        <div class="card-header">
          <h4>収支</h4>
        </div>
        <div class="card-body">
          <canvas id="pie_way"></canvas>
          <table class="table table-light table-hover table-sm">
            <thead>
              <tr>
                <th>Key</th>
                <th class="right">Value</th>
              </tr>
            </thead>
            <tbody>
              {% for cw in current_way %}
              <tr>
                <td>{{cw.way}}</td>
                <td class="right">¥{{cw.sum | intcomma}}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="col-sm-12 col-md-6 col-lg-3">
      <div class="card">
        <div class="card-header">
          <h4>用途別</h4>
        </div>
        <div class="card-body">
          <canvas id="pie_usage"></canvas>
          <table class="table table-light table-hover table-sm">
            <thead>
              <tr>
                <th>Key</th>
                <th class="right">Value</th>
              </tr>
            </thead>
            <tbody class="">
              {%for cu in current_usage%}
              <tr>
                <td>{{cu.usage__name}}</td>
                <td class="right">¥{{cu.sum | intcomma}}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="col-sm-12 col-md-6 col-lg-3">
      <div class="card">
        <div class="card-header">
          <h4>資産状態</h4>
        </div>
        <div class="card-body">
          <canvas id="pie_resource"></canvas>
          <!--<canvas id="bar_resources" width="320" height="360"></canvas>-->
          <table class="table table-light table-hover table-sm">
            <thead>
              <tr>
                <th>Key</th>
                <th class="right">Value</th>
              </tr>
            </thead>
            <tbody class="">
              {% for cr in current_resource %}
              <tr>
                <td>{{cr.name}}</td>
                <td class="right">¥{{cr.current_val | intcomma}}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="col-sm-12 col-md-6 col-lg-3">
      <div class="card">
        <div class="card-header">
          <h4>先月比</h4>
        </div>
        <div class="card-body">
          <canvas id="bar_resources" width="320" height="360"></canvas>
          <table class="table table-light table-hover table-sm">
            <thead>
              <tr>
                <th>Key</th>
                <th class="right">今月</th>
                <th class="right">先月</th>
              </tr>
            </thead>
            <tbody class="">
              {%for r in resources_chart%}
              <tr>
                <td>{{r.name}}</td>
                <td class="right">¥{{r.this_month | intcomma}}</td>
                <td class="right">¥{{r.last_month | intcomma}}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  <hr>

  <!--共通家計簿-->
  <div class="row" id="link-shared">
    <div class="col-sm-6">
      <h2><i class="fas fa-people-carry"></i> 共通家計簿</h2>
    </div>
  </div>
  <div class="row">
    <div class="col-sm-6 col-md-3 col-lg-2">
      <button class="btn btn-block btn-lg btn-{{status.shared}}">
        収支 <span class="badge badge-light">¥{{seisan.inout | intcomma}}</span>
      </button>
    </div>
    <div class="col-sm-6 col-md-3 col-lg-2">
      <button class="btn btn-block btn-lg btn-info">
        精算 <span class="badge badge-light">¥{{seisan.seisan | intcomma}}</span>
      </button>
    </div>
    <div class="col-sm-12 col-md-6 col-lg-8">
      <div class="progress" style="height:25px">
        <div class="progress-bar bg-success progress-bar-striped" style="width:{{pb.shared.in}}%; height:25px">
          予算 <span class="badge badge-light">¥{{seisan.budget.sum | intcomma}}</span>
        </div>
      </div>
      <div class="progress" style="height:25px">
        <div class="progress-bar bg-warning progress-bar-striped" style="width:{{pb.shared.out}}%; height:25px">
          支出 <span class="badge badge-light">¥{{seisan.payment.sum | intcomma}}</span>
        </div>
      </div>
    </div>
  </div>
  <hr>
  <div class="row">
    <div class="col-sm-6 col-md-4">
      <div class="card">
        <div class="card-header">
          <h4>支払者別</h4>
        </div>
        <div class="card-body">
          <canvas id="pie_shared_paid_by"></canvas>
          <table class="table table-light table-hover table-sm">
            <thead>
              <tr>
                <th>Key</th>
                <th class="right">Value</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>敬士</td>
                <td class="right">¥{{seisan.payment.taka | intcomma}}</td>
              </tr>
              <tr>
                <td>朋子</td>
                <td class="right">¥{{seisan.payment.hoko | intcomma}}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="col-sm-6 col-md-4">
      <div class="card">
        <div class="card-header">
          <h4>用途別</h4>
        </div>
        <div class="card-body">
          <canvas id="pie_shared_usage"></canvas>
          <table class="table table-light table-hover table-sm">
            <thead>
              <tr>
                <th>Key</th>
                <th class="right">Value</th>
              </tr>
            </thead>
            <tbody>
            {% for su in shared_grouped_by_usage %}
              <tr>
                <td>{{su.usage__name}}</td>
                <td class="right">¥{{su.sum|intcomma}}</td>
              </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="col-sm-6 col-md-4">
      <div class="card">
        <div class="card-header">
          <h4>支払い内訳</h4>
        </div>
        <div class="card-body">
          <canvas id="bar_eom" width="320" height="360"></canvas>
        </div>
      </div>
    </div>
  </div>
  <hr>

  <!--資産運用-->
  <div class="row" id="link-asset">
    <div class="col-sm-6">
      <h2><i class="far fa-money-bill-alt"></i> 資産運用</h2>
    </div>
  </div>
  <div class="row">
    <div class="col-4">
    </div>
    <div class="col-4">
    </div>
    <div class="col-4">
    </div>
  </div>
  <hr>
  <div class="row">
  <hr>

</div>

<!--============================================================ -->
                          <!--MODAL-->
<!--============================================================ -->
<!-- Modal new-record -->
<div class="modal fade" id="new_record" tabindex="-1" role="dialog" aria-labelledby="new_record" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="new_record_Label">
          <i class="far fa-plus-square"></i> New Kakeibo Record
        </h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <form method="post" action="">
        <div class="modal-body">
          {% csrf_token %}
          <table>
            {{ kakeibo_form }}
          </table>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          <button type="submit" class="btn btn-primary" name="post_type" value="new_record">Register</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal read_csv -->
<div class="modal fade" id="read_csv" tabindex="-1" role="dialog" aria-labelledby="read_csv" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="read_csv_Label">
          <i class="far fa-file-excel"></i> Read credit CSV
        </h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <script>
        $(function(){
          $('.dropify').dropify();
        })
      </script>
      <form class="form-horizontal" method="post" action="" enctype="multipart/form-data">
        <div class="modal-body">
          <input type="file" class="dropify" name="csv">
          {% csrf_token %}
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          <button type="submit" class="btn btn-primary" name="post_type" value="read_csv">Submit</button>
        </div>
      </form>
    </div>
  </div>
</div>


<!--============================================================ -->
                          <!--SCRIPT-->
<!--============================================================ -->
<!-- pie_usage -->
<script>
  var ctx = document.getElementById('pie_usage').getContext('2d');
  var myChart = new Chart(ctx, {
    type: 'pie',
    data: {
      labels: [{%for cu in current_usage%}"{{cu.usage__name}}",{%endfor%}],
      datasets: [{
        label: "alice",
        data: [{%for cu in current_usage%}{{cu.sum}},{%endfor%}],
        backgroundColor: [
          "#2ecc71",
          "#3498db",
          "#95a5a6",
          "#9b59b6",
          "#f1c40f",
          "#e74c3c",
          "#34495e",
          "#bee95e",

          "#2ecc71",
          "#3498db",
          "#95a5a6",
          "#9b59b6",
          "#f1c40f",
          "#e74c3c",
          "#34495e",
          "#bee95e",
         ]
      }]
    },
    options: {
      <!--responsive: true,-->
      legend: {
        position: "right",
        display: false
      }
    }
  });
</script>

<!-- pie_way -->
<script>
  var ctx = document.getElementById('pie_way').getContext('2d');
  var myChart = new Chart(ctx, {
    type: 'pie',
    data: {
      labels: [{% for cw in current_way %}"{{cw.way}}",{%endfor%}],
      datasets: [{
        label: "alice",
        data: [{% for cw in current_way %}{{cw.sum}},{%endfor%}],
        backgroundColor: [
          "#2ecc71",
          "#3498db",
          "#95a5a6",
          "#9b59b6",
          "#f1c40f",
          "#e74c3c",
          "#34495e",
          "#bee95e",

          "#2ecc71",
          "#3498db",
          "#95a5a6",
          "#9b59b6",
          "#f1c40f",
          "#e74c3c",
          "#34495e",
          "#bee95e",
         ]
      }]
    },
    options: {
      <!--responsive: true,-->
      legend: {
        position: "right",
        display: false
      }
    }
  });
</script>

<!-- pie_resource -->
<script>
  var ctx = document.getElementById('pie_resource').getContext('2d');
  ctx.canvas.width = 100
  ctx.canvas.height = 100
  var myChart = new Chart(ctx, {
    type: 'pie',
    data: {
      labels: [{% for cr in current_resource %}"{{cr.name}}",{%endfor%}],
      datasets: [{
        label: "alice",
        data: [{% for cr in current_resource %}{{cr.current_val}},{%endfor%}],
        backgroundColor: [
          "#2ecc71",
          "#3498db",
          "#95a5a6",
          "#9b59b6",
          "#f1c40f",
          "#e74c3c",
          "#34495e",
          "#bee95e",
         ]
      }]
    },
    options: {
      <!--responsive: true,-->
      legend: {
        position: "right",
        display: false
      }
    }
  });
</script>

<!-- pie_shared_usage -->
<script>
  var ctx = document.getElementById('pie_shared_usage').getContext('2d');
  var myChart = new Chart(ctx, {
    type: 'pie',
    data: {
      labels: [{%for su in shared_grouped_by_usage%}"{{su.usage__name}}",{%endfor%}],
      datasets: [{
        label: "alice",
        data: [{%for su in shared_grouped_by_usage%}{{su.sum}},{%endfor%}],
        backgroundColor: [
          "#2ecc71",
          "#3498db",
          "#95a5a6",
          "#9b59b6",
          "#f1c40f",
          "#e74c3c",
          "#34495e"
         ]
      }]
    },
    options: {
      responsive: true,
      legend: {
        position: "right"
      }
    }
  });
</script>

<!-- pie_shared_paid_by -->
<script>
  var ctx = document.getElementById('pie_shared_paid_by').getContext('2d');
  var myChart = new Chart(ctx, {
    type: 'pie',
    data: {
      labels: ["敬士", "朋子"],
      datasets: [{
        label: "alice",
        data: [{{seisan.payment.taka}}, {{seisan.payment.hoko}}],
        backgroundColor: [
          "#2ecc71",
          "#3498db"
         ]
      }]
    },
    options: {
      responsive: true,
      legend: {
        position: "right"
      }
    }
  });
</script>

<!-- bar_resources -->
<script>
  var ctx = document.getElementById('bar_resources').getContext('2d');
  ctx.canvas.width = 100
  ctx.canvas.height = 100
  var options = {
    scales: {
      yAxes: [{
        stacked: true
      }]
    },
    legend: {
      display: false
    }
  }
  var colors = [
    "rgba(250,153,0,0.4)",
    "rgba(0,153,253,0.4)",
    "rgba(153,250,0,0.4)",
    "rgba(153,0,253, 0.4)",
    "rgba(253,0,150,0.4)",
    "rgba(0,253,150,0.4)",
  ]
  var myChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: ["今月", "先月"],
      datasets: [
        {%for r in resources_chart%}
        {
          label: "{{r.name}}",
          data: [{{r.this_month}}, {{r.last_month}}],
          backgroundColor: colors[{{ forloop.counter0 }}]
        },
        {% endfor %}
      ],
    },
    options: options
  });
</script>

<!-- bar_eom -->
<script>
  var ctx = document.getElementById('bar_eom').getContext('2d');
  var options = {
    scales: {
      yAxes: [{
        stacked: true
      }]
    }
  }
  var colors = [
    "rgba(250,153,  0,0.4)",
    "rgba(  0,153,253,0.4)",
    "rgba(153,250,  0,0.4)",
    "rgba(153,  0,253,0.4)",
    "rgba(253,  0,150,0.4)",
    "rgba(  0,253,153,0.4)",
  ]
  var myChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: [{%for l in bar_eom.labels%}"{{l}}",{%endfor%}],
      datasets: [
        {%for key,val in bar_eom.data.items%}
        {
          label: "{{key}}",
          data: [{%for v in val%}{{v}},{%endfor%}],
          backgroundColor: colors[{{ forloop.counter0 }}]
        },
        {% endfor %}
      ],
    },
    options: options
  });
</script>
{% endblock %}