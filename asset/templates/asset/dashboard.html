{% extends "kakeibo/base.html" %}
{% load humanize %}
{% block title %}
    Asset dashboard
{% endblock %}

{% block body %}
  <div class="container-fluid">
    <hr>
    <div class="row">
      <div class="col-sm-7">
        <h1>
          <i class="fab fa-servicestack"></i> 資産運用概要: {{today.year}}/{{today.month}}/{{today.day}}
        </h1>
      </div>
      <div class="col-sm-5">
        <!-- Button trigger modal -->
        <button type="button" class="btn btn-outline-info" data-toggle="modal" data-target="#add_investment">
          <i class="far fa-plus-square"></i> Additional investment
        </button>
        <button type="button" class="btn btn-outline-info" data-toggle="modal" data-target="#register_stock">
           <i class="far fa-plus-square"></i> New stock
        </button>
        <button type="button" class="btn btn-outline-info" data-toggle="modal" data-target="#order">
          <i class="far fa-plus-square"></i> New order
        </button>
      </div>
    </div>
    <hr>

    <!-- Graphs -->
    <h2>Graphs</h2>
    <div class="row">
      <div class="col-sm-3">
        <canvas id="pie_holding_stocks"></canvas>
      </div>
      <div class="col-sm-5">
        <canvas id="bar_holding_stocks"></canvas>
      </div>
      <div class="col-sm-4">
        <table class="table table-light table-hover table-sm">
          <thead>
            <tr>
              <th>Key</th>
              <th class="right">Val</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>保有株式</td>
              <td class="right">¥ {{total| intcomma}}</td>
            </tr>
            <tr>
              <td>その他投資</td>
              <td class="right">¥{{alatest.other_value| intcomma}}</td>
            </tr>
            <tr>
              <td>買付余力</td>
              <td class="right">¥{{alatest.buying_power | intcomma}}</td>
            </tr>
            <tr>
              <td>総計</td>
              <td class="right">¥{{total_b| intcomma}}</td>
            </tr>
            <tr>
              <td>収益</td>
              <td class="right"><font color="{{total_color}}">¥{{benefit| intcomma}}</font></td>
            </tr>
            <tr>
              <td>投資額</td>
              <td class="right">¥{{alatest.investment| intcomma}}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <hr>

    <!-- Table -->
    <h2>Holding Stocks</h2>
    <div class="row">
      <div class="col-sm-12">
        <table class="table table-light table-hover table-sm table-responsive-md">
          <thead>
            <tr>
              <th>Buying Date</th>
              <th>Code</th>
              <th>Name</th>
              <th class="right">Num</th>
              <th class="right">Buying price</th>
              <th class="right">Current price</th>
              <th class="right">Total</th>
              <th class="right">Benefit</th>
            </tr>
          </thead>
          <tbody>
            {% for hs in hstocks %}
            <tr>
              <td>{{hs.date}}</td>
              <td>{{hs.code}}</td>
              <td>{{hs.name}}</td>
              <td class="right">{{hs.num}}</td>
              <td class="right">¥{{hs.aprice | intcomma}}</td>
              <td class="right">¥{{hs.cprice | intcomma}}</td>
              <td class="right">¥{{hs.ctotal | intcomma}}</td>
              <td class="right"><font color="{{hs.color}}">¥{{hs.benefit | intcomma}}</font></td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    <hr>

    <h2>Date shift</h2>
    <div class="row">
      <div class="col-sm-12">
        <ul class="nav nav-tabs">
          <li class="nav-item">
            <a href="#fig1" class="nav-link" data-toggle="tab">全データ</a>
          </li>
          <li class="nav-item">
            <a href="#fig2" class="nav-link active" data-toggle="tab">最近のデータ</a>
          </li>
        </ul>
        <div class="tab-content">
          <div id="fig1" class="tab-pane">
            <canvas id="date_shift_all"></canvas>
          </div>
          <div id="fig2" class="tab-pane active">
            <canvas id="date_shift"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal add_investment-->
  <div class="modal fade" id="add_investment" tabindex="-1" role="dialog" aria-labelledby="add_investment" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="add_investment_Label">Additional investment</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <form method="post">
          <div class="modal-body">
            {% csrf_token %}
            <table>
              {{ add_investment_form.as_table }}
            </table>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            <button type="submit" class="btn btn-primary" name="post_type" value="add_investment">Save changes</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <!-- Modal register_stock-->
  <div class="modal fade" id="register_stock" tabindex="-1" role="dialog" aria-labelledby="register_stock" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="register_stock_Label">New stock</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <form method="post" action="">
          <div class="modal-body">
            {% csrf_token %}
            <table>
                {{ stock_form }}
            </table>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            <button type="submit" class="btn btn-primary" name="post_type" value="stock_form">Register</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <!-- Modal order-->
  <div class="modal fade" id="order" tabindex="-1" role="dialog" aria-labelledby="order" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="register_stock_Label">New order</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <form method="post" action="">
          <div class="modal-body">
            {% csrf_token %}
            <table>
                {{ order_form }}
            </table>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            <button type="submit" class="btn btn-primary" name="post_type" value="order_form">Register</button>
          </div>
        </form>
      </div>
    </div>
  </div>


  <!-- pie_holding_stocks -->
  <script>
    var ctx = document.getElementById('pie_holding_stocks').getContext('2d');
    var myChart = new Chart(ctx, {
      type: 'pie',
      data: {
        labels: ["Buying power", {%for hs in hstocks%}"{{hs.code}}",{%endfor%}],
        datasets: [{
          label: "alice",
          data: [{{alatest.buying_power}}, {%for hs in hstocks%}{{hs.ctotal}},{%endfor%}],
          backgroundColor: [
            "#2ecc71",
            "#3498db",
            "#95a5a6",
            "#9b59b6",
            "#f1c40f",
            "#e74c3c",
            "#34495e"
           ]
        }]
      }
    });
  </script>

  <!-- bar_holding_stocks -->
  <script>
    var ctx = document.getElementById('bar_holding_stocks').getContext('2d');
    var myChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: [{%for hs in hstocks%}"{{hs.code}}",{%endfor%}],
        datasets: [
            {
                label: 'Buying price',
                data: [
                    {%for hs in hstocks%}{{hs.atotal}},{%endfor%}
                ],
                backgroundColor: "rgba(153,255,51,0.4)"
            },
            {
                label: 'Current price',
                data: [
                    {%for hs in hstocks%}{{hs.ctotal}},{%endfor%}
                ],
                backgroundColor: "rgba(255,153,0,0.4)"
            }
        ],
      },
    });
  </script>

  <!-- bar_holding_stocks_% -->
  <script>
    var ctx = document.getElementById('bar_holding_stocks_percent').getContext('2d');
    var myChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: [{%for hs in hstocks%}"{{hs.code}}",{%endfor%}],
        datasets: [
            {
                label: 'Buying price',
                data: [
                    {%for hs in hstocks%}{{hs.atotal}}/{{hs.atotal}},{%endfor%}
                ],
                backgroundColor: "rgba(153,255,51,0.4)"
            },
            {
                label: 'Current price',
                data: [
                    {%for hs in hstocks%}{{hs.ctotal}}/{{hs.atotal}},{%endfor%}
                ],
                backgroundColor: "rgba(255,153,0,0.4)"
            }
        ],
      },
      options: {
        scales: {
          yAxes: [{ticks: {beginAtZero: true, min: 0,}}]
        }
      }
    });
  </script>

  <!-- Date shift all -->
  <script>
    var lineChartData = {
      labels : [{%for ass in astatus%} "{{ass.date}}", {%endfor%} "{{ today }}"],
      datasets : [
        {
          label: "その他投資",
          data: [{%for ass in astatus%} {{ass.other_value}}, {%endfor%} {{alatest.other_value}}],
          backgroundColor: "rgba(53,255,151,0.4)",
          //fill: false,
        },
        {
          label: "株式",
          data: [{%for ass in astatus%} {{ass.stocks_value}}, {%endfor%} {{total}}],
          backgroundColor: "rgba(255,153,0,0.4)",
          //fill: false,
        },
        {
          label: "買付余力",
          data: [{%for ass in astatus%} {{ass.buying_power}}, {%endfor%} {{alatest.buying_power}}],
          backgroundColor: "rgba(153,255,51,0.4)",
          //fill: false,
        },
      ]
    }
    var options = {
      scales: {
        yAxes: [{
          stacked: true
        }]
      },
      responsive: true,
    }
    var ctx = document.getElementById("date_shift_all").getContext("2d");
    var myChart = new Chart(ctx, {
        type: "line",
        data: lineChartData,
        options: options,
        // 下記を追加すると線がまっすぐになります
        /* bezierCurve: false */
    });
  </script>


 <!-- Date shift -->
  <script>
    var lineChartData = {
      labels : [{%for ass in astatus_recent%} "{{ass.date}}" {%endfor%} "{{ today }}"],
      datasets : [
        {
          label: "その他投資",
          data: [{%for ass in astatus_recent%} {{ass.other_value}} {%endfor%} {{alatest.other_value}}],
          backgroundColor: "rgba(53,255,151,0.4)",
          //fill: false,
        },
        {
          label: "株式",
          data: [{%for ass in astatus_recent%} {{ass.stocks_value}} {%endfor%} {{total}}],
          backgroundColor: "rgba(255,153,0,0.4)",
          //fill: false,
        },
        {
          label: "買付余力",
          data: [{%for ass in astatus_recent%} {{ass.buying_power}} {%endfor%} {{alatest.buying_power}}],
          backgroundColor: "rgba(153,255,51,0.4)",
          //fill: false,
        },
      ]
    }
    var options = {
      scales: {
        yAxes: [{
          stacked: true
        }]
      },
      responsive: true,
    }
    var ctx = document.getElementById("date_shift").getContext("2d");
    var myChart = new Chart(ctx, {
        type: "line",
        data: lineChartData,
        options: options,
        // 下記を追加すると線がまっすぐになります
        /* bezierCurve: false */
    });
  </script>
{% endblock %}
