{% extends "kakeibo/base.html" %}
{% load humanize %}
{% load web_template %}
{% block title %}
    Stock Detail {{stock}}
{% endblock %}

{% block body %}
<div class="container-fluid">
	<div class="row">
		<div class="col-12">
			<h4><i class="fas fa-paw"></i> Stock Detail</h4>
		</div>
	</div>
	<div class="row">
		<div class="col-12 col-sm-6">
			<h5>Overview</h5>
			<table class="table">
				<tr>
					<th>Code</th>
					<td>{{stock.code}}</td>
				</tr>
				<tr>
					<th>Name</th>
					<td>{{stock.name}}</td>
				</tr>
				<tr>
					<th>Type</th>
					<td>
						{%if stock.is_trust%}
						<label class="badge badge-info">投資信託</label>
						{%else%}
						<label class="badge badge-success">株</label>
						{%endif%}
					</td>
				</tr>
				<tr>
					<th>Market</th>
					<td>{{stock.market |default:"-"}}</td>
				</tr>
				<tr>
					<th>Industry</th>
					<td>{{stock.industry |default:"-"}}</td>
				</tr>
				<tr>
					<th>Current Val</th>
					<td>{{current_val |yen}}</td>
				</tr>
				<tr>
					<th>Latest Val</th>
					<td>{{stock.latest_val |yen}} ({{stock.latest_val_date}})</td>
				</tr>
			</table>
		</div>
		<div class="col-12 col-sm-6">
			<h5>Entry</h5>
			<table class="table">
				<tr>
					<th>No</th>
					<th>Type</th>
					<th>Status</th>
					<th>Open</th>
					<th>Close</th>
					<th>Profit</th>
				</tr>
				{% for entry in stock.entry_set.all %}
				<tr>
					<td>
						<a href="{%url 'web:entry_detail' pk=entry.id %}">
							{{entry.id}}
						</a>
					</td>
					<td>
						{% include 'web/part/entry_type.html' %}
					</td>
					<td>
						{% include 'web/part/entry_close_status.html' %}
					</td>
					<td>{{entry.date_open |date}}</td>
					<td>{{entry.date_close |date}}</td>
					<td class="right">{{entry.profit |yen |safe}}</td>
				</tr>
				{% endfor %}
			</table>
			<hr>
			<h5>Alert</h5>
			<table class="table">
				<tr>
					<th>No</th>
					<th>Open</th>
					<th>Alert</th>
				</tr>
				{% for sbialert in sbialerts %}
				<tr>
					<td>{{sbialert.id}}</td>
					<td>{{sbialert.created_at}}</td>
					<td>{{sbialert.val}} {{sbialert.get_type_display}}</td>
				</tr>
				{% endfor %}
			</table>
		</div>
	</div>

	<div class="row">
		<div class="col-12">
			{% include 'web/modal/modal_sbialert.html' %}
			{% include 'web/modal/modal_new_entry.html' %}
			<a class="btn btn-outline-secondary" href="{%url 'web:stock_list' %}">
				<i class="fas fa-backward"></i> Back to list
			</a>
		</div>
	</div>

	<hr>
	<div class="row">
		<div class="col-12 col-sm-8">
			<div class="card">
				<div class="card-header">
					<h5>Chart {% include 'web/part/trend_type.html' %}</h5>
				</div>
				<div class="card-body">
					<p class="card-title">{{svds.first.date}} ~ {{svds.last.date}}</p>
					<div class="candlestick-1day"></div>
					<p class="card-title">終値</p>
					<canvas id="analysis" width="300" height="150"></canvas>
				</div>
				<div class="card-footer">

				</div>
			</div>
		</div>
		<div class="col-12 col-sm-4">
			<div class="card">
				<div class="card-header">
					<h5>Finance {% include 'web/part/finance_type.html' %}</h5>
				</div>
				<div class="card-body">
					{%with sfd=sfds.last%}
					<table class="table">
						<tr>
							<th>ROE</th>
							<td>{{sfd.roe}}</td>
						</tr>
						<tr>
							<th>ROA</th>
							<td>{{sfd.roa}}</td>
						</tr>
						<tr>
							<th>EPS</th>
							<td>{{sfd.eps_f}}</td>
						</tr>
						<tr>
							<th>PER</th>
							<td>{{sfd.per_f}}</td>
						</tr>
						<tr>
							<th>時価総額</th>
							<td>{{sfd.market_value |intcomma}}</td>
						</tr>
						<tr>
							<th>自己資本比率</th>
							<td>{{sfd.equity_ratio}}%</td>
						</tr>
					</table>
					{%endwith%}
				</div>
				<div class="card-footer">

				</div>
			</div>
		</div>
	</div>
</div>
{% include 'web/part/chart.html' %}

<script src="/document/js/candlestick.js"></script>
<script>
	window.onload = function() {
		var trades = [
			{% for o in entry.order_set.all %}
			{
				date: "{{o.datetime|date:"Y-m-d"}}",
				type: "{%if o.is_buy%}buy{%else%}sell{%endif%}",
				price: {{o.val}},
				quantity: {{o.num}},
			},
      {% endfor %}
    ];
    var data = [
      {% for svd in svds %}
      {
        Date: "{{svd.date|date:"Y-m-d"}}",
        High: {{svd.val_high}},
        Low: {{svd.val_low}},
        Open: {{svd.val_open}},
        Close: {{svd.val_close}},
        Volume: {{svd.turnover}},
      },
      {% endfor %}
    ];
		displayCandlestick(data, "1day", trades);
		// 画面をリサイズした時に発火する
		$(window).on("resize", function() {
			displayCandlestick(data, "1day", trades);
		});
	}
</script>

{% endblock %}